<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Collaborative Canvas</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Ensure scripts load properly */
        .script-loading { background: #f0f0f0; color: white; padding: 20px; border-radius: 8px; margin: 20px; }
        .script-error { background: #dc3545; color: white; padding: 20px; border-radius: 8px; margin: 20px; }
        .script-success { background: #28a745; color: white; padding: 20px; border-radius: 8px; margin: 20px; }
    </style>
</head>
<body>
    <div id="loading" class="script-loading">
        <h2>üîÑ Loading Collaborative Canvas...</h2>
        <p>Please wait while we initialize the application...</p>
    </div>

    <!-- Load scripts with proper error handling -->
    <script>
        // Script loading status
        let scriptsLoaded = {
            socketio: false,
            canvas: false,
            websocket: false,
            main: false
        };
        
        // Check if Socket.io is available
        function checkScript(name, src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    scriptsLoaded[name] = true;
                    document.getElementById('loading').innerHTML += `<div class="script-success">‚úÖ ${name} loaded</div>`;
                    console.log(`‚úÖ ${name} loaded successfully`);
                    resolve(true);
                };
                script.onerror = (error) => {
                    scriptsLoaded[name] = false;
                    document.getElementById('loading').innerHTML += `<div class="script-error">‚ùå ${name} failed: ${error.message}</div>`;
                    console.error(`‚ùå ${name} failed:`, error);
                    reject(error);
                };
                
                // Add error handling timeout
                setTimeout(() => {
                    if (scriptsLoaded[name] !== true) {
                        reject(new Error(`${name} loading timeout`));
                    }
                }, 5000);
                
                document.head.appendChild(script);
            });
        }
        
        // Load all scripts sequentially
        async function loadAllScripts() {
            console.log('Starting script loading...');
            
            try {
                await checkScript('/socket.io/socket.io.js', 'Socket.io Client');
                await checkScript('canvas.js', 'Canvas Class');
                await checkScript('websocket.js', 'WebSocket Manager');
                await checkScript('main.js', 'Main Controller');
                
                // All scripts loaded, initialize app
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loading').innerHTML = `
                    <div class="script-success">‚úÖ All scripts loaded successfully!</div>
                    <div style="margin-top: 20px;">
                        <button onclick="initializeApp()">üöÄ Start Application</button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Script loading failed:', error);
                document.getElementById('loading').innerHTML = `<div class="script-error">‚ùå Script loading failed: ${error.message}</div>`;
            }
        }
        
        // Initialize the application
        function initializeApp() {
            if (typeof DrawingCanvas !== 'undefined' && typeof WebSocketManager !== 'undefined') {
                console.log('üöÄ Initializing Collaborative Canvas...');
                
                // Remove the loading screen and show the actual app
                document.body.innerHTML = `
                    <div id="controls">
                        <div id="drawingTools">
                            <button id="penTool" class="tool-btn active">‚úèÔ∏è Pen</button>
                            <button id="eraserTool" class="tool-btn">üßπ Eraser</button>
                        </div>
                        <div id="drawingSettings">
                            <input type="color" id="colorPicker" value="#000000">
                            <input type="range" id="brushSize" min="1" max="20" value="3">
                            <span id="sizeDisplay">3</span>
                        </div>
                        <div id="drawingActions">
                            <button id="undoBtn">‚Ü∂ Undo</button>
                            <button id="redoBtn">‚Ü∑ Redo</button>
                            <button id="clearBtn">üóëÔ∏è Clear</button>
                        </div>
                        <div id="roomSection">
                            <input type="text" id="roomInput" placeholder="Room name">
                            <button id="joinBtn">Join</button>
                            <span id="roomDisplay">Room: none</span>
                        </div>
                    </div>
                    <canvas id="drawingCanvas"></canvas>
                    
                    <script src="/socket.io/socket.io.js"></script>
                    <script>
                        // Initialize the actual application
                        const canvas = new DrawingCanvas(document.getElementById('drawingCanvas'));
                        const wsManager = new WebSocketManager(canvas);
                        wsManager.connect();
                        
                        // Set up event listeners
                        canvas.setSegmentCallback((points, color, width) => {
                            wsManager.sendStrokeSegment(points, color, width);
                        });
                        
                        // Drawing tools
                        document.getElementById('penTool').addEventListener('click', () => {
                            canvas.setEraser(false);
                        });
                        
                        document.getElementById('eraserTool').addEventListener('click', () => {
                            canvas.setEraser(true);
                        });
                        
                        document.getElementById('colorPicker').addEventListener('change', (e) => {
                            canvas.setColor(e.target.value);
                        });
                        
                        document.getElementById('brushSize').addEventListener('input', (e) => {
                            canvas.setWidth(parseInt(e.target.value));
                        });
                        
                        document.getElementById('undoBtn').addEventListener('click', () => {
                            const removed = canvas.removeLastStroke();
                            if (removed) {
                                wsManager.sendGlobalUndo(removed);
                            }
                        });
                        
                        document.getElementById('clearBtn').addEventListener('click', () => {
                            if (confirm('Clear entire canvas for everyone?')) {
                                canvas.clearCanvas();
                                wsManager.sendClear();
                            }
                        });
                        
                        // Room joining
                        document.getElementById('joinBtn').addEventListener('click', () => {
                            const roomName = document.getElementById('roomInput').value.trim();
                            if (roomName) {
                                wsManager.joinRoom(roomName);
                            }
                        });
                    </script>
                </div>
            `;
            }
            
            loadAllScripts();
        }
        
        // Start the loading process
        loadAllScripts();
    </script>
</body>
</html>